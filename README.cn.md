# FreshRSS-AutoTTL-Improved 扩展

[Read English Version](README.md)

> **注意**: 这是基于 [mgnsk/FreshRSS-AutoTTL](https://github.com/mgnsk/FreshRSS-AutoTTL) 的改进版本，增强了智能动态 TTL 计算功能。

一个增强版的 FreshRSS 扩展，用于智能自动 feed 刷新 TTL 计算。它通过时间段、星期几差异和更新间隔来分析 feed 更新模式，动态优化刷新频率。

## 主要改进

相比原版，本版本添加了以下增强功能：

- **时间段分析**: 识别每个 feed 最活跃的更新小时（0-23 点）
- **星期几模式识别**: 自动检测并适应每周各天（周一到周日）的不同更新模式，完全基于实际数据，不做假设
- **动态间隔分析**: 分析不同时间段的更新间隔变化
- **智能降级**: 当数据不足时回退到简单平均算法
- **平滑算法**: 防止 TTL 值波动，确保稳定的刷新行为
- **增强的统计面板**: 显示详细的分析结果，包括数据质量、活跃时段和星期几模式

## 工作原理

扩展分析 feed 更新的三个关键特征：

1. **更新时间集中度**: 识别一天中哪些小时更新最频繁
2. **动态间隔差异**: 分析更新间隔在不同时间段的变化
3. **星期几特征**: 区分每周各天（周一到周日）的更新模式

基于这些分析，它计算一个适应当前时间的动态 TTL，确保 feed 在最佳间隔刷新。

## TTL 计算逻辑详解

> **时区说明**: 时间分析使用 FreshRSS 用户设置中配置的时区。如果 FreshRSS 中未配置时区，则回退到服务器的默认时区（PHP 的 `date_default_timezone_get()`）。扩展使用数据库中的 Unix 时间戳，并使用配置的时区将其转换为本地时间，用于小时和星期几的分析。

### 一、数据收集与分析阶段

1. **数据获取**
   - 从数据库中获取最近 N 天的 feed 条目数据（可配置，默认：30 天）
   - 按时间顺序排序，计算相邻条目之间的时间间隔

2. **数据质量判断**
   - **数据不足**（< 10 条）：使用简单平均间隔 = (最后时间 - 最早时间) / (条目数 - 1)
   - **数据充足**（>= 30 条且 >= 7 天）：进行完整的多维度分析

3. **模式分析**（数据充足时）
   - **时间段分析**：统计每个小时（0-23 点）的更新次数和平均间隔
   - **星期几分析**：统计每个星期几（周日=0, 周一=1, ..., 周六=6）的平均更新间隔
   - **更新密度**：计算每个时段的更新密度 = 更新次数 / 覆盖天数

### 二、动态 TTL 计算阶段

当需要计算 TTL 时，根据当前时间动态计算：

1. **基础间隔确定** (`baseInterval`)
   - 优先使用当前时段的平均间隔（如果有数据）
   - 如果当前时段无数据，使用所有时段的平均值
   - 如果所有时段都无数据，使用简单平均间隔

2. **星期几调整**
   - 如果当前星期几有实际更新数据，使用该星期几的平均间隔
   - 如果当前星期几无数据，使用其他有数据的星期几的平均值
   - **重要**：完全基于实际数据，不做任何假设（如"周末更新频率减半"等）

3. **小时密度加权** (`hourWeight`)
   - 计算当前时段的更新密度相对于平均密度的比值
   - 密度越高，权重越小（更新更频繁，TTL 更短）
   - 权重限制在 0.5 到 2.0 之间

4. **TTL 计算**
   ```
   dynamicTTL = baseInterval * hourWeight
   ```

### 三、平滑处理与边界约束

1. **平滑处理**
   - 为了避免 TTL 值剧烈波动，使用指数平滑算法
   - 新 TTL = 旧 TTL × 0.7 + 新计算的 TTL × 0.3

2. **边界约束**
   - 最小值：`defaultTTL`（系统默认 TTL）
   - 最大值：`maxTTL`（配置的最大 TTL）
   - 最终 TTL 值限制在此范围内

### 四、缓存机制

- **模式缓存**：分析结果缓存 1 小时，避免频繁重复分析
- **TTL 缓存**：计算得到的 TTL 缓存 5 分钟，提高响应速度
- Feed 更新后自动清除缓存，确保使用最新数据

### 计算示例

假设某个 feed 的历史数据：
- 周一至周五平均更新间隔：2 小时
- 周六、周日平均更新间隔：6 小时
- 当前时间：周三 14:00（周三有数据，14 点时段有数据）

计算过程：
1. 使用周三的平均间隔：2 小时 = 7200 秒
2. 14 点时段密度加权：假设权重为 1.0
3. TTL = 7200 × 1.0 = 7200 秒（2 小时）
4. 平滑处理（如果有旧值）
5. 边界约束（确保在 defaultTTL 和 maxTTL 之间）

# 配置

主要可配置的值：

- **Max TTL**: Feed 更新的最大生存时间间隔
- **Statistics table rows**: 统计表格中显示的 feed 数量
- **Statistics days**: 从数据库获取 feed 条目数据用于分析的天数（默认：30 天，范围：1-365 天）

使用默认 TTL 的 feed 会在默认 TTL 和最大 TTL 之间的间隔更新，根据其更新模式动态调整。

例如，默认 TTL 为 `1h`，最大 TTL 为 `1d` 时，feed 每天至少更新一次，但不会超过每小时一次，具体间隔根据以下因素智能计算：
- Feed 的历史更新模式
- 当前时间（活跃时段）
- 当前是星期几（周一到周日）
- 更新间隔变化

## 统计面板

扩展提供了一个全面的统计面板，显示：

- **数据质量**: 是否有完整分析或仅限数据模式
- **简单平均 TTL**: 传统的平均 TTL 计算（用于对比）
- **动态 TTL（当前）**: 基于当前时间和模式实时计算的 TTL
- **活跃时段**: 每个 feed 的前 3 个最活跃更新小时
- **星期几模式**: 每周各天（周日、周一、周二、周三、周四、周五、周六）的更新间隔，基于实际数据
- **最后更新和下次更新**: Feed 刷新的时间信息

![Screenshot FreshRSS-AutoTTL-Improved · Extensions · FreshRSS](https://github.com/user-attachments/assets/66545901-ae62-4153-8ff6-42601cde0e0a)

# 测试

- `docker compose pull`
- `docker compose up`
- 在浏览器中打开 `http://localhost:8080`

## MySQL 凭据

- 主机: `mysql`
- 用户名: `freshrss`
- 密码: `freshrss`
- 数据库: `freshrss`

## PostgreSQL 凭据

- 主机: `postgres`
- 用户名: `freshrss`
- 密码: `freshrss`
- 数据库: `freshrss`

要重置，运行 `docker compose down`。

运行 `docker compose exec freshrss php /var/www/FreshRSS/app/actualize_script.php` 手动执行更新脚本。

## 致谢

- 原始扩展: [mgnsk/FreshRSS-AutoTTL](https://github.com/mgnsk/FreshRSS-AutoTTL)
- 本改进版本添加了智能动态 TTL 计算，包括时间段分析、星期几模式识别（基于实际数据，不做假设）和增强的统计可视化。

## 许可证

AGPL-3.0（与原项目相同）

